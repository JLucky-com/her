<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Our Sky â€” Anniversary</title>
  <style>
    :root {
      --bg: #051025;
      --panel: rgba(255, 255, 255, 0.06);
      --accent: #ff6b81;
      --text: #eef;
      --text-dim: rgba(238, 238, 255, 0.7);
    }
    
    * {
      box-sizing: border-box;
      touch-action: none;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      background: radial-gradient(1200px 600px at 10% 10%, rgba(80, 50, 140, 0.15), transparent), var(--bg);
      color: var(--text);
    }
    
    #app {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
    }
    
    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.05), transparent);
      backdrop-filter: blur(8px);
      z-index: 10;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    .title {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-right: 12px;
    }
    
    .logo {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: linear-gradient(135deg, #2a1b4d, #3b2b6a);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #ffd;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      flex-shrink: 0;
    }
    
    h1 {
      font-size: 16px;
      margin: 0;
      font-weight: 600;
      line-height: 1.3;
    }
    
    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
      width: 100%;
      justify-content: space-between;
    }
    
    button {
      background: var(--panel);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 8px 12px;
      border-radius: 8px;
      color: var(--accent);
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      justify-content: center;
      min-width: 0;
      white-space: nowrap;
    }
    
    button:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    button.toggle {
      color: #bfe8ff;
    }
    
    #canvasWrap {
      flex: 1;
      position: relative;
      overflow: hidden;
      touch-action: none;
    }
    
    canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    
    .legend {
      position: absolute;
      left: 12px;
      bottom: 12px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.05), transparent);
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(8px);
      z-index: 5;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      font-size: 13px;
      max-width: calc(100% - 24px);
    }
    
    .modal {
      position: absolute;
      right: 12px;
      top: 12px;
      width: 90%;
      max-width: 320px;
      max-height: calc(100% - 24px);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.05), transparent);
      border-radius: 10px;
      padding: 14px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(8px);
      z-index: 5;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      overflow-y: auto;
      transition: transform 0.3s ease, opacity 0.3s ease;
      -webkit-overflow-scrolling: touch;
    }
    
    .modal.hidden {
      transform: translateX(20px);
      opacity: 0;
      pointer-events: none;
    }
    
    .modal h3 {
      margin: 0 0 10px 0;
      font-weight: 600;
      color: var(--accent);
      font-size: 16px;
    }
    
    .small {
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.4;
    }
    
    .star-btn {
      display: block;
      width: 100%;
      text-align: left;
      padding: 10px;
      border-radius: 8px;
      border: 1px dashed rgba(255, 255, 255, 0.1);
      margin-top: 8px;
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      font-size: 13px;
      transition: all 0.2s ease;
    }
    
    .star-btn:active {
      background: rgba(255, 255, 255, 0.08);
    }
    
    .footer {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .heart {
      color: var(--accent);
    }
    
    .constellation {
      stroke: rgba(255, 255, 255, 0.15);
      stroke-width: 1px;
    }
    
    .modal-content {
      margin-bottom: 12px;
    }
    
    .modal-content img {
      width: 100%;
      border-radius: 8px;
      margin-top: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-close:active {
      color: var(--text);
    }
    
    .zoom-controls {
      position: absolute;
      right: 12px;
      bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 5;
    }
    
    .zoom-controls button {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      border-radius: 50%;
      font-size: 16px;
      flex: 0 0 auto;
    }
    
    .mobile-message-toggle {
      position: absolute;
      left: 12px;
      top: 12px;
      width: 36px;
      height: 36px;
      background: var(--panel);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
      display: none;
    }
    
    @media (max-width: 768px) {
      header {
        padding: 10px 12px;
      }
      
      .logo {
        width: 36px;
        height: 36px;
        font-size: 14px;
      }
      
      h1 {
        font-size: 15px;
      }
      
      .controls {
        gap: 6px;
      }
      
      button {
        padding: 8px 10px;
        font-size: 12px;
      }
      
      .mobile-message-toggle {
        display: flex;
      }
      
      .modal {
        width: calc(100% - 24px);
        max-width: none;
      }
    }
    
    @media (max-width: 480px) {
      .legend {
        font-size: 12px;
        padding: 8px 10px;
      }
      
      .zoom-controls button {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }
      
      .modal {
        padding: 12px;
      }
    }
    
    /* Animation classes */
    @keyframes twinkle {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }
    
    .twinkle {
      animation: twinkle 3s infinite ease-in-out;
    }
  </style>
  <meta name="theme-color" content="#051025">
  <link rel="manifest" href="manifest.json">
</head>
<body>
<div id="app">
  <header>
    <div class="title">
      <div class="logo">â˜…</div>
      <div>
        <h1>Our Sky â€” 28 Oct 2025</h1>
        <div class="small">Bandar Lampung, Indonesia</div>
      </div>
    </div>
    <div class="controls">
      <button id="modeToggle" class="toggle">
        <span id="modeIcon">ðŸŒŒ</span>
        <span id="modeText">Artistic Mode</span>
      </button>
      <button id="resetView">
        <span>ðŸ”­</span>
        <span>Reset</span>
      </button>
      <button id="downloadPNG">
        <span>ðŸ“·</span>
        <span>Save</span>
      </button>
    </div>
  </header>

  <div id="canvasWrap">
    <canvas id="skyCanvas"></canvas>

    <button class="mobile-message-toggle" id="mobileToggleMessages">ðŸ’¬</button>

    <div class="legend">
      <div><strong>Mode:</strong> <span id="modeLabel">Realistic</span></div>
      <div class="small"><span id="dateLabel"></span></div>
      <div class="small">Tap stars for messages</div>
    </div>

    <div class="zoom-controls">
      <button id="zoomIn">+</button>
      <button id="zoomOut">-</button>
    </div>

    <div class="modal hidden" id="infoPanel">
      <button class="modal-close" id="closeModal">Ã—</button>
      <h3>Star Messages</h3>
      <div class="small">Tap any star to view its message</div>
      <div id="messagesList"></div>
      <div class="footer">
        Made with <span class="heart">â™¥</span>
      </div>
    </div>

    <div class="modal hidden" id="starModal">
      <button class="modal-close" id="closeStarModal">Ã—</button>
      <div id="starModalContent">
        <h3 id="starModalTitle">Star Name</h3>
        <div class="small" id="starModalInfo">Magnitude: 0.0 â€¢ Distance: 0 ly</div>
        <div class="modal-content" id="starModalText">Loading...</div>
      </div>
    </div>
  </div>
</div>

<script>
// --------------------------- CONFIG ---------------------------
const TARGET_DATE = new Date('2025-10-28T20:00:00+07:00');
const TARGET_LAT = -5.4296 * Math.PI/180;
const TARGET_LON = 105.2629 * Math.PI/180;
const LOCATION_NAME = "Bandar Lampung, Indonesia";

// Star catalog with essential bright stars
const STAR_CATALOG = [
  {id:'Sirius', name: 'Sirius', ra:6.752481, dec:-16.716116, mag:-1.46, dist: 8.6, messageKey: 'sirius'},
  {id:'Canopus', name: 'Canopus', ra:6.399199, dec:-52.695661, mag:-0.74, dist: 310, messageKey: 'canopus'},
  {id:'Arcturus', name: 'Arcturus', ra:14.261208, dec:19.182417, mag:-0.05, dist: 36.7, messageKey: 'arcturus'},
  {id:'Vega', name: 'Vega', ra:18.615649, dec:38.783689, mag:0.03, dist: 25, messageKey: 'vega'},
  {id:'Capella', name: 'Capella', ra:5.278155, dec:45.997991, mag:0.08, dist: 42.8, messageKey: 'capella'},
  {id:'Rigel', name: 'Rigel', ra:5.242298, dec:-8.201640, mag:0.12, dist: 860, messageKey: 'rigel'},
  {id:'Procyon', name: 'Procyon', ra:7.655033, dec:5.225, mag:0.38, dist: 11.46, messageKey: 'procyon'},
  {id:'Betelgeuse', name: 'Betelgeuse', ra:5.919529, dec:7.407064, mag:0.42, dist: 548, messageKey: 'betelgeuse'},
  {id:'Achernar', name: 'Achernar', ra:1.628571, dec:-57.236753, mag:0.46, dist: 139, messageKey: 'achernar'},
  {id:'Hadar', name: 'Hadar', ra:14.063724, dec:-60.373039, mag:0.61, dist: 390, messageKey: 'hadar'},
  {id:'Altair', name: 'Altair', ra:19.846389, dec:8.868322, mag:0.77, dist: 16.73, messageKey: 'altair'},
  {id:'Aldebaran', name: 'Aldebaran', ra:4.598677, dec:16.509302, mag:0.85, dist: 65.3, messageKey: 'aldebaran'},
  {id:'Antares', name: 'Antares', ra:16.490129, dec:-26.431946, mag:1.06, dist: 550, messageKey: 'antares'},
  {id:'Spica', name: 'Spica', ra:13.419884, dec:-11.161322, mag:0.98, dist: 250, messageKey: 'spica'},
  {id:'Pollux', name: 'Pollux', ra:7.755263, dec:28.026195, mag:1.14, dist: 33.78, messageKey: 'pollux'}
];

// Constellation lines data
const CONSTELLATION_LINES = [
  {from: 'Betelgeuse', to: 'Rigel'},
  {from: 'Betelgeuse', to: 'Bellatrix'},
  {from: 'Rigel', to: 'Saiph'}
];

// Personalized messages
const starMessages = {
  'sirius': {
    title: 'Sirius - The Brightest Star',
    date: '2023-05-15',
    text: 'Remember our first trip under the stars? Sirius was shining brightly that night, just like the sparkle in your eyes.',
    image: '',
    distance: '8.6 light years',
    magnitude: '-1.46'
  },
  'vega': {
    title: 'Vega - The Harp Star',
    date: '2024-01-10',
    text: 'The night we listened to your favorite songs under the stars, Vega was directly overhead. I think of you whenever I see it now.',
    image: '',
    distance: '25 light years',
    magnitude: '0.03'
  }
};

// --------------------------- INITIALIZATION ---------------------------
const canvas = document.getElementById('skyCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
let W, H, centerX, centerY, scale = 1, panX = 0, panY = 0;
let mode = 'realistic';
let isDragging = false;
let lastX = 0, lastY = 0;
let animationFrameId = null;
let hoveredStar = null;
let touchZoomInitialDistance = null;

// Performance optimization
const offscreenCanvas = document.createElement('canvas');
const offscreenCtx = offscreenCanvas.getContext('2d');
let backgroundCache = null;

// Mobile detection
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

// --------------------------- UTILITY FUNCTIONS ---------------------------
function toRad(d) { return d * Math.PI / 180 }
function toDeg(r) { return r * 180 / Math.PI }

function dateToJD(date) {
  const Y = date.getUTCFullYear();
  const M = date.getUTCMonth() + 1;
  const D = date.getUTCDate() + (date.getUTCHours() / 24) + (date.getUTCMinutes() / 1440) + (date.getUTCSeconds() / 86400);
  let y = Y, m = M;
  if (m <= 2) { y = Y - 1; m = M + 12; }
  const A = Math.floor(y / 100);
  const B = 2 - A + Math.floor(A / 4);
  return Math.floor(365.25 * (y + 4716)) + Math.floor(30.6001 * (m + 1)) + D + B - 1524.5;
}

function gstFromJD(JD) {
  const T = (JD - 2451545.0) / 36525.0;
  let S = 280.46061837 + 360.98564736629 * (JD - 2451545.0) + 0.000387933 * T * T - (T * T * T) / 38710000.0;
  S = ((S % 360) + 360) % 360;
  return toRad(S);
}

function raDecToAltAz(raHours, decDeg, date, latRad, lonRad) {
  const jd = dateToJD(date);
  const gst = gstFromJD(jd);
  const lst = (gst + lonRad) % (2 * Math.PI);
  const ra = toRad(raHours * 15.0);
  const dec = toRad(decDeg);
  let ha = lst - ra;
  ha = ((ha + Math.PI) % (2 * Math.PI)) - Math.PI;
  const sinAlt = Math.sin(dec) * Math.sin(latRad) + Math.cos(dec) * Math.cos(latRad) * Math.cos(ha);
  const alt = Math.asin(sinAlt);
  const y = -Math.sin(ha) * Math.cos(dec);
  const x = Math.cos(latRad) * Math.sin(dec) - Math.sin(latRad) * Math.cos(dec) * Math.cos(ha);
  let az = Math.atan2(y, x);
  az = (az + 2 * Math.PI) % (2 * Math.PI);
  return { alt, az };
}

// --------------------------- RENDERING FUNCTIONS ---------------------------
function resize() {
  const dpr = window.devicePixelRatio || 1;
  W = canvas.clientWidth;
  H = canvas.clientHeight;
  canvas.width = Math.floor(W * dpr);
  canvas.height = Math.floor(H * dpr);
  offscreenCanvas.width = canvas.width;
  offscreenCanvas.height = canvas.height;
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  offscreenCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
  centerX = W / 2;
  centerY = H / 2;
  backgroundCache = null;
}

window.addEventListener('resize', () => {
  resize();
  render();
});

resize();

function projectAzAlt(az, alt) {
  const rMax = Math.min(W, H) * 0.45 * scale;
  const coalt = Math.PI / 2 - alt;
  const r = (coalt / (Math.PI / 2)) * rMax;
  const x = centerX + (r * Math.sin(az)) + panX;
  const y = centerY - (r * Math.cos(az)) + panY;
  return { x, y, r };
}

function computeRealisticPositions() {
  const positions = [];
  STAR_CATALOG.forEach(s => {
    const { alt, az } = raDecToAltAz(s.ra, s.dec, TARGET_DATE, TARGET_LAT, TARGET_LON);
    positions.push({ 
      id: s.id,
      name: s.name,
      alt,
      az,
      mag: s.mag,
      distance: s.dist,
      messageKey: s.messageKey
    });
  });
  return positions;
}

let realisticPositions = computeRealisticPositions();

function generateConstellationLines() {
  const lines = [];
  const starMap = {};
  
  realisticPositions.forEach(star => {
    starMap[star.id] = star;
  });
  
  CONSTELLATION_LINES.forEach(line => {
    const fromStar = starMap[line.from];
    const toStar = starMap[line.to];
    
    if (fromStar && toStar && fromStar.alt > -0.1 && toStar.alt > -0.1) {
      const fromProj = projectAzAlt(fromStar.az, fromStar.alt);
      const toProj = projectAzAlt(toStar.az, toStar.alt);
      
      if (fromProj && toProj) {
        lines.push({
          fromX: fromProj.x,
          fromY: fromProj.y,
          toX: toProj.x,
          toY: toProj.y
        });
      }
    }
  });
  
  return lines;
}

let constellationLines = generateConstellationLines();

function generateArtisticStars(count = 200) {
  const arr = [];
  for (let i = 0; i < count; i++) {
    arr.push({
      x: Math.random() * W,
      y: Math.random() * H,
      mag: Math.random() * 3,
      vx: (Math.random() - 0.5) * 0.1,
      vy: (Math.random() - 0.5) * 0.1
    });
  }
  return arr;
}

let artisticStars = generateArtisticStars(isMobile ? 150 : 250);

function isPointInView(x, y) {
  const buffer = 100;
  return x > -buffer && x < W + buffer && y > -buffer && y < H + buffer;
}

function drawBackground() {
  if (backgroundCache) {
    offscreenCtx.drawImage(backgroundCache, 0, 0);
    return;
  }
  
  const g = offscreenCtx.createLinearGradient(0, 0, 0, H);
  g.addColorStop(0, 'rgba(10, 12, 25, 0.85)');
  g.addColorStop(1, 'rgba(6, 8, 18, 0.95)');
  
  offscreenCtx.fillStyle = g;
  offscreenCtx.fillRect(0, 0, W, H);
  
  backgroundCache = document.createElement('canvas');
  backgroundCache.width = W;
  backgroundCache.height = H;
  backgroundCache.getContext('2d').drawImage(offscreenCanvas, 0, 0);
}

function drawStar(x, y, size, name, mag) {
  const hue = 200;
  const saturation = 50;
  const lightness = 90 - Math.max(0, mag) * 5;
  
  const g = offscreenCtx.createRadialGradient(x, y, 0, x, y, size * 3);
  g.addColorStop(0, `hsla(${hue}, ${saturation}%, ${lightness}%, 0.9)`);
  g.addColorStop(0.7, `hsla(${hue}, ${saturation}%, ${lightness}%, 0.2)`);
  g.addColorStop(1, 'transparent');
  
  offscreenCtx.save();
  offscreenCtx.globalCompositeOperation = 'lighter';
  offscreenCtx.fillStyle = g;
  offscreenCtx.beginPath();
  offscreenCtx.arc(x, y, size * 1.5, 0, Math.PI * 2);
  offscreenCtx.fill();
  
  offscreenCtx.fillStyle = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
  offscreenCtx.beginPath();
  offscreenCtx.arc(x, y, size * 0.5, 0, Math.PI * 2);
  offscreenCtx.fill();
  offscreenCtx.restore();
  
  if (mag < 1 && !isMobile && isPointInView(x, y + 20)) {
    offscreenCtx.font = '12px sans-serif';
    offscreenCtx.fillStyle = 'rgba(255, 255, 255, 0.7)';
    offscreenCtx.textAlign = 'center';
    offscreenCtx.fillText(name || '', x, y + 20);
  }
}

function drawGlowing(x, y, size) {
  const hue = 200 + Math.sin(x / 100 + y / 150) * 40;
  const saturation = 40 + Math.sin(x / 50) * 20;
  const lightness = 70 + Math.cos(y / 70) * 15;
  
  const g = offscreenCtx.createRadialGradient(x, y, 0, x, y, size * 4);
  g.addColorStop(0, `hsla(${hue}, ${saturation}%, ${lightness}%, 0.8)`);
  g.addColorStop(0.3, `hsla(${hue + 10}, ${saturation - 10}%, ${lightness - 10}%, 0.3)`);
  g.addColorStop(1, 'transparent');
  
  offscreenCtx.save();
  offscreenCtx.globalCompositeOperation = 'lighter';
  offscreenCtx.fillStyle = g;
  offscreenCtx.beginPath();
  offscreenCtx.arc(x, y, size * 2, 0, Math.PI * 2);
  offscreenCtx.fill();
  offscreenCtx.restore();
}

function drawHoverEffect(x, y, mag) {
  const size = 10 + (3 - Math.min(3, mag)) * 2;
  
  offscreenCtx.save();
  offscreenCtx.strokeStyle = 'rgba(255, 107, 129, 0.6)';
  offscreenCtx.lineWidth = 2;
  offscreenCtx.beginPath();
  offscreenCtx.arc(x, y, size, 0, Math.PI * 2);
  offscreenCtx.stroke();
  offscreenCtx.restore();
}

function drawHeart(x, y) {
  offscreenCtx.save();
  offscreenCtx.translate(x, y);
  
  offscreenCtx.beginPath();
  offscreenCtx.moveTo(0, -6);
  offscreenCtx.bezierCurveTo(8, -20, 28, -10, 0, 22);
  offscreenCtx.bezierCurveTo(-28, -10, -8, -20, 0, -6);
  offscreenCtx.fillStyle = 'rgba(255, 107, 129, 0.95)';
  offscreenCtx.fill();
  
  offscreenCtx.restore();
}

function drawBigHeart(x, y) {
  offscreenCtx.save();
  offscreenCtx.globalAlpha = 0.85;
  
  const g = offscreenCtx.createRadialGradient(x, y, 0, x, y, 180);
  g.addColorStop(0, 'rgba(255, 107, 129, 0.08)');
  g.addColorStop(1, 'transparent');
  
  offscreenCtx.fillStyle = g;
  offscreenCtx.beginPath();
  offscreenCtx.moveTo(x, y - 40);
  offscreenCtx.bezierCurveTo(x + 60, y - 120, x + 180, y - 40, x, y + 120);
  offscreenCtx.bezierCurveTo(x - 180, y - 40, x - 60, y - 120, x, y - 40);
  offscreenCtx.fill();
  
  offscreenCtx.restore();
}

function drawConstellationLines() {
  constellationLines.forEach(line => {
    offscreenCtx.beginPath();
    offscreenCtx.moveTo(line.fromX, line.fromY);
    offscreenCtx.lineTo(line.toX, line.toY);
    offscreenCtx.strokeStyle = 'rgba(180, 200, 255, 0.15)';
    offscreenCtx.lineWidth = 1;
    offscreenCtx.stroke();
  });
}

function findStarAt(mx, my) {
  if (mode === 'realistic') {
    for (let i = realisticPositions.length - 1; i >= 0; i--) {
      const p = realisticPositions[i];
      if (p.alt < -0.1) continue;
      
      const proj = projectAzAlt(p.az, p.alt);
      const rad = Math.max(3, 6 - (p.mag || 2));
      
      if (Math.hypot(mx - proj.x, my - proj.y) < rad + 10) {
        return {
          type: 'real',
          id: p.id,
          name: p.name,
          proj,
          mag: p.mag,
          distance: p.distance,
          messageKey: p.messageKey
        };
      }
    }
  } else {
    const brightStars = artisticStars.filter(s => s.mag < 1.5);
    for (const s of brightStars) {
      const rad = 2 + (3 - Math.min(3, s.mag));
      if (Math.hypot(mx - s.x, my - s.y) < rad + 10) {
        return {
          type: 'art',
          id: null,
          proj: { x: s.x, y: s.y },
          mag: s.mag
        };
      }
    }
  }
  return null;
}

let lastRenderTime = 0;
const renderInterval = 1000 / (isMobile ? 30 : 60); // Throttle for mobile

function render(currentTime) {
  if (currentTime - lastRenderTime < renderInterval) {
    animationFrameId = requestAnimationFrame(render);
    return;
  }
  
  lastRenderTime = currentTime;
  
  offscreenCtx.clearRect(0, 0, W, H);
  drawBackground();
  
  if (mode === 'realistic') {
    drawConstellationLines();
    
    realisticPositions.forEach(p => {
      if (p.alt < -0.1) return;
      
      const proj = projectAzAlt(p.az, p.alt);
      const size = Math.max(1.2, 6 - p.mag);
      const tw = 0.6 + 0.4 * Math.sin(currentTime / 300 + (p.id.length));
      
      if (isPointInView(proj.x, proj.y)) {
        drawStar(proj.x, proj.y, size * tw, p.name, p.mag);
      }
    });
    
    const eventZenith = { alt: Math.PI / 2 - 0.2, az: Math.PI / 4 };
    const evp = projectAzAlt(eventZenith.az, eventZenith.alt);
    drawHeart(evp.x, evp.y);
    
    if (hoveredStar && hoveredStar.type === 'real') {
      drawHoverEffect(hoveredStar.proj.x, hoveredStar.proj.y, hoveredStar.mag);
    }
  } else {
    artisticStars.forEach(s => {
      s.x += s.vx;
      s.y += s.vy;
      
      if (s.x < -50) s.x = W + 50;
      if (s.x > W + 50) s.x = -50;
      if (s.y < -50) s.y = H + 50;
      if (s.y > H + 50) s.y = -50;
      
      if (isPointInView(s.x, s.y)) {
        drawGlowing(s.x, s.y, 1 + (3 - Math.min(3, s.mag)) * 0.6);
      }
    });
    
    drawBigHeart(centerX + panX, centerY + panY);
    
    if (hoveredStar && hoveredStar.type === 'art') {
      drawHoverEffect(hoveredStar.proj.x, hoveredStar.proj.y, hoveredStar.mag);
    }
  }
  
  ctx.drawImage(offscreenCanvas, 0, 0);
  animationFrameId = requestAnimationFrame(render);
}

animationFrameId = requestAnimationFrame(render);

// --------------------------- UI CONTROLS ---------------------------
function toggleMode() {
  if (mode === 'realistic') {
    mode = 'artistic';
    document.getElementById('modeText').textContent = 'Realistic Mode';
    document.getElementById('modeIcon').textContent = 'ðŸŒ ';
    document.getElementById('modeLabel').textContent = 'Artistic';
  } else {
    mode = 'realistic';
    document.getElementById('modeText').textContent = 'Artistic Mode';
    document.getElementById('modeIcon').textContent = 'ðŸŒŒ';
    document.getElementById('modeLabel').textContent = 'Realistic';
    realisticPositions = computeRealisticPositions();
    constellationLines = generateConstellationLines();
  }
}

document.getElementById('modeToggle').addEventListener('click', toggleMode);

document.getElementById('dateLabel').textContent = TARGET_DATE.toLocaleString('en-US', {
  month: 'short',
  day: 'numeric',
  year: 'numeric',
  hour: '2-digit',
  minute: '2-digit'
});

document.getElementById('resetView').addEventListener('click', () => {
  scale = 1;
  panX = 0;
  panY = 0;
  realisticPositions = computeRealisticPositions();
  constellationLines = generateConstellationLines();
});

document.getElementById('zoomIn').addEventListener('click', () => {
  scale *= 1.2;
  scale = Math.min(2, scale);
});

document.getElementById('zoomOut').addEventListener('click', () => {
  scale *= 0.8;
  scale = Math.max(0.5, scale);
});

document.getElementById('downloadPNG').addEventListener('click', () => {
  const tempCanvas = document.createElement('canvas');
  const tempCtx = tempCanvas.getContext('2d');
  const scaleFactor = isMobile ? 1.5 : 2;
  
  tempCanvas.width = W * scaleFactor;
  tempCanvas.height = H * scaleFactor;
  
  // Draw everything at higher resolution
  if (mode === 'realistic') {
    const bgGradient = tempCtx.createLinearGradient(0, 0, 0, tempCanvas.height);
    bgGradient.addColorStop(0, 'rgba(10, 12, 25, 0.85)');
    bgGradient.addColorStop(1, 'rgba(6, 8, 18, 0.95)');
    tempCtx.fillStyle = bgGradient;
    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
    
    drawConstellationLines.call({ ctx: tempCtx, scaleFactor });
    
    realisticPositions.forEach(p => {
      if (p.alt < -0.1) return;
      
      const proj = projectAzAlt(p.az, p.alt);
      const size = Math.max(1.2, 6 - p.mag) * scaleFactor;
      
      // Draw star
      const hue = 200;
      const saturation = 50;
      const lightness = 90;
      
      const g = tempCtx.createRadialGradient(
        proj.x * scaleFactor, proj.y * scaleFactor, 0,
        proj.x * scaleFactor, proj.y * scaleFactor, size * 1.5
      );
      g.addColorStop(0, `hsla(${hue}, ${saturation}%, ${lightness}%, 0.9)`);
      g.addColorStop(0.7, `hsla(${hue}, ${saturation}%, ${lightness}%, 0.2)`);
      g.addColorStop(1, 'transparent');
      
      tempCtx.fillStyle = g;
      tempCtx.beginPath();
      tempCtx.arc(proj.x * scaleFactor, proj.y * scaleFactor, size * 1.5, 0, Math.PI * 2);
      tempCtx.fill();
      
      tempCtx.fillStyle = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
      tempCtx.beginPath();
      tempCtx.arc(proj.x * scaleFactor, proj.y * scaleFactor, size * 0.5, 0, Math.PI * 2);
      tempCtx.fill();
    });
  } else {
    const bgGradient = tempCtx.createLinearGradient(0, 0, 0, tempCanvas.height);
    bgGradient.addColorStop(0, 'rgba(10, 12, 25, 0.85)');
    bgGradient.addColorStop(1, 'rgba(6, 8, 18, 0.95)');
    tempCtx.fillStyle = bgGradient;
    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
    
    artisticStars.forEach(s => {
      const size = (1 + (3 - Math.min(3, s.mag)) * 0.6 * scaleFactor;
      const hue = 200 + Math.sin(s.x / 100 + s.y / 150) * 40;
      const saturation = 40 + Math.sin(s.x / 50) * 20;
      const lightness = 70 + Math.cos(s.y / 70) * 15;
      
      const g = tempCtx.createRadialGradient(
        s.x * scaleFactor, s.y * scaleFactor, 0,
        s.x * scaleFactor, s.y * scaleFactor, size * 4
      );
      g.addColorStop(0, `hsla(${hue}, ${saturation}%, ${lightness}%, 0.8)`);
      g.addColorStop(0.3, `hsla(${hue + 10}, ${saturation - 10}%, ${lightness - 10}%, 0.3)`);
      g.addColorStop(1, 'transparent');
      
      tempCtx.save();
      tempCtx.globalCompositeOperation = 'lighter';
      tempCtx.fillStyle = g;
      tempCtx.beginPath();
      tempCtx.arc(s.x * scaleFactor, s.y * scaleFactor, size * 2, 0, Math.PI * 2);
      tempCtx.fill();
      tempCtx.restore();
    });
  }
  
  // Add watermark
  tempCtx.font = `${14 * scaleFactor}px sans-serif`;
  tempCtx.fillStyle = 'rgba(255, 255, 255, 0.5)';
  tempCtx.textAlign = 'right';
  tempCtx.fillText('Our Star Map â€¢ ' + TARGET_DATE.toLocaleDateString(), 
    tempCanvas.width - 20 * scaleFactor, tempCanvas.height - 20 * scaleFactor);
  
  // Download
  const link = document.createElement('a');
  link.download = `our-sky-${TARGET_DATE.toISOString().split('T')[0]}.png`;
  link.href = tempCanvas.toDataURL('image/png');
  link.click();
});

// --------------------------- MODAL CONTROLS ---------------------------
function openStarModal(hit) {
  const modal = document.getElementById('starModal');
  const title = document.getElementById('starModalTitle');
  const info = document.getElementById('starModalInfo');
  const text = document.getElementById('starModalText');
  
  document.getElementById('infoPanel').classList.add('hidden');
  
  if (hit.type === 'real' && hit.messageKey && starMessages[hit.messageKey]) {
    const data = starMessages[hit.messageKey];
    title.textContent = data.title || hit.name || hit.id;
    
    let infoText = `Magnitude: ${hit.mag.toFixed(2)}`;
    if (hit.distance) infoText += ` â€¢ Distance: ${hit.distance} light years`;
    info.textContent = infoText;
    
    let contentHTML = `<p>${data.text}</p>`;
    if (data.date) {
      contentHTML += `<p class="small">${new Date(data.date).toLocaleDateString()}</p>`;
    }
    if (data.image) {
      contentHTML += `<img src="${data.image}" alt="${data.title}" loading="lazy">`;
    }
    
    text.innerHTML = contentHTML;
  } else {
    title.textContent = hit.id || 'A Special Star';
    info.textContent = `Magnitude: ${hit.mag.toFixed(2)}`;
    text.innerHTML = `<p>This star shines bright in our sky, just like you shine in my life.</p>`;
  }
  
  modal.classList.remove('hidden');
}

function closeStarModal() {
  document.getElementById('starModal').classList.add('hidden');
}

function toggleMessagesPanel() {
  document.getElementById('infoPanel').classList.toggle('hidden');
}

document.getElementById('closeModal').addEventListener('click', toggleMessagesPanel);
document.getElementById('closeStarModal').addEventListener('click', closeStarModal);
document.getElementById('mobileToggleMessages').addEventListener('click', toggleMessagesPanel);

// --------------------------- TOUCH HANDLERS ---------------------------
function handleTouchStart(e) {
  if (e.touches.length === 1) {
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    lastX = touch.clientX - rect.left;
    lastY = touch.clientY - rect.top;
    isDragging = true;
    
    // Check if we're hitting a star
    hoveredStar = findStarAt(lastX, lastY);
  } else if (e.touches.length === 2) {
    // Pinch zoom
    const touch1 = e.touches[0];
    const touch2 = e.touches[1];
    touchZoomInitialDistance = Math.hypot(
      touch1.clientX - touch2.clientX,
      touch1.clientY - touch2.clientY
    );
  }
}

function handleTouchMove(e) {
  if (e.touches.length === 1 && isDragging) {
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const mx = touch.clientX - rect.left;
    const my = touch.clientY - rect.top;
    
    panX += mx - lastX;
    panY += my - lastY;
    
    lastX = mx;
    lastY = my;
    
    hoveredStar = findStarAt(mx, my);
  } else if (e.touches.length === 2 && touchZoomInitialDistance !== null) {
    // Handle pinch zoom
    const touch1 = e.touches[0];
    const touch2 = e.touches[1];
    const currentDistance = Math.hypot(
      touch1.clientX - touch2.clientX,
      touch1.clientY - touch2.clientY
    );
    
    const delta = currentDistance / touchZoomInitialDistance;
    const newScale = scale * delta;
    
    if (newScale >= 0.5 && newScale <= 2) {
      // Calculate center point between fingers
      const rect = canvas.getBoundingClientRect();
      const centerX = ((touch1.clientX + touch2.clientX) / 2 - rect.left);
      const centerY = ((touch1.clientY + touch2.clientY) / 2 - rect.top);
      
      // Adjust pan to zoom toward center point
      panX = centerX - delta * (centerX - panX);
      panY = centerY - delta * (centerY - panY);
      
      scale = newScale;
    }
    
    touchZoomInitialDistance = currentDistance;
  }
}

function handleTouchEnd(e) {
  if (e.touches.length === 0) {
    isDragging = false;
    touchZoomInitialDistance = null;
    
    // If we weren't dragging much, treat it as a click
    if (!isDragging && hoveredStar) {
      openStarModal(hoveredStar);
    }
  }
}

canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
canvas.addEventListener('touchend', handleTouchEnd);

// --------------------------- MOUSE HANDLERS ---------------------------
canvas.addEventListener('mousedown', e => {
  const rect = canvas.getBoundingClientRect();
  lastX = e.clientX - rect.left;
  lastY = e.clientY - rect.top;
  isDragging = true;
});

canvas.addEventListener('mousemove', e => {
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  
  if (isDragging) {
    panX += mx - lastX;
    panY += my - lastY;
    lastX = mx;
    lastY = my;
  }
  
  hoveredStar = findStarAt(mx, my);
  canvas.style.cursor = hoveredStar ? 'pointer' : (isDragging ? 'grabbing' : 'grab');
});

canvas.addEventListener('mouseup', () => {
  isDragging = false;
  canvas.style.cursor = hoveredStar ? 'pointer' : 'grab';
});

canvas.addEventListener('mouseleave', () => {
  isDragging = false;
  canvas.style.cursor = 'default';
});

canvas.addEventListener('click', e => {
  if (!isDragging && hoveredStar) {
    openStarModal(hoveredStar);
  }
});

canvas.addEventListener('wheel', e => {
  e.preventDefault();
  
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left - panX;
  const mouseY = e.clientY - rect.top - panY;
  
  const delta = e.deltaY > 0 ? 0.9 : 1.1;
  const newScale = scale * delta;
  
  if (newScale < 0.5 || newScale > 2) return;
  
  panX = mouseX - delta * (mouseX - panX);
  panY = mouseY - delta * (mouseY - panY);
  
  scale = newScale;
}, { passive: false });

// --------------------------- INITIALIZATION ---------------------------
// Populate messages list
function refreshMessagesList() {
  const container = document.getElementById('messagesList');
  container.innerHTML = '';
  
  Object.keys(starMessages).forEach(k => {
    const message = starMessages[k];
    const btn = document.createElement('button');
    btn.className = 'star-btn';
    
    let btnText = `<strong>${message.title || k}</strong>`;
    if (message.date) {
      btnText += `<br><span class="small">${new Date(message.date).toLocaleDateString()}</span>`;
    }
    btnText += `<br>${message.text.slice(0, 40)}${message.text.length > 40 ? '...' : ''}`;
    
    btn.innerHTML = btnText;
    btn.addEventListener('click', () => {
      const modal = document.getElementById('starModal');
      const title = document.getElementById('starModalTitle');
      const info = document.getElementById('starModalInfo');
      const text = document.getElementById('starModalText');
      
      title.textContent = message.title || k;
      info.textContent = `Magnitude: ${message.magnitude || '?'} â€¢ Distance: ${message.distance || '?'}`;
      
      let contentHTML = `<p>${message.text}</p>`;
      if (message.date) {
        contentHTML += `<p class="small">${new Date(message.date).toLocaleDateString()}</p>`;
      }
      if (message.image) {
        contentHTML += `<img src="${message.image}" alt="${message.title}" loading="lazy">`;
      }
      
      text.innerHTML = contentHTML;
      
      document.getElementById('infoPanel').classList.add('hidden');
      modal.classList.remove('hidden');
    });
    
    container.appendChild(btn);
  });
  
  if (Object.keys(starMessages).length === 0) {
    const btn = document.createElement('button');
    btn.className = 'star-btn';
    btn.textContent = 'No messages yet. Edit the HTML to add your own!';
    container.appendChild(btn);
  }
}

refreshMessagesList();

// Hide info panel by default on mobile
if (isMobile) {
  document.getElementById('infoPanel').classList.add('hidden');
}

// Clean up
window.addEventListener('beforeunload', () => {
  if (animationFrameId) {
    cancelAnimationFrame(animationFrameId);
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.key === 'r' || e.key === 'R') {
    document.getElementById('resetView').click();
  } else if (e.key === 'm' || e.key === 'M') {
    toggleMode();
  } else if (e.key === 'Escape') {
    closeStarModal();
  }
});

// Prevent elastic scrolling on iOS
if (isIOS) {
  document.body.style.overflow = 'hidden';
  document.body.style.position = 'fixed';
  document.body.style.width = '100%';
  document.body.style.height = '100%';
}
</script>
</body>
</html>
